<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙŠØ¯Ù„Ø© - V14 (Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #1565c0; --bg: #f0f4f8; --accent: #1976d2; --success: #2e7d32; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg); margin: 0; padding: 5px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 15px; border-radius: 10px; min-height: 90vh; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        /* Tabs Navigation */
        .nav-tabs { display: flex; gap: 8px; margin-bottom: 20px; background: #e3f2fd; padding: 5px; border-radius: 8px; }
        .nav-item { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-weight: bold; border-radius: 6px; transition: 0.2s; color: #555; }
        .nav-item.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .section { display: none; animation: fadeIn 0.3s ease-in-out; }
        .section.active { display: block; }

        /* Inputs & Forms */
        .form-group { margin-bottom: 18px; position: relative; }
        label { display: block; font-weight: bold; margin-bottom: 6px; color: #444; }
        input, select { width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 8px; box-sizing: border-box; font-size: 16px; transition: 0.2s; background: #fafafa; }
        input:focus, select:focus { border-color: var(--primary); outline: none; background: white; }
        select:disabled { background: #eee; color: #aaa; cursor: not-allowed; }

        /* Buttons */
        button { width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: bold; color: white; cursor: pointer; margin-top: 8px; font-size: 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: 0.2s; }
        button:active { transform: scale(0.98); }
        .btn-import { background-color: var(--primary); }
        .btn-save { background-color: var(--success); }
        .btn-report { background-color: #7b1fa2; }
        .btn-backup { background-color: #f57c00; }
        .btn-reset { background-color: #c62828; margin-top: 25px; font-size: 14px; opacity: 0.8; }
        
        /* Clear Button inside input */
        .clear-btn { position: absolute; left: 10px; top: 42px; color: #999; cursor: pointer; font-size: 18px; display: none; }
        
        /* Console & Balance */
        .debug-console { background: #263238; color: #80cbc4; padding: 12px; height: 80px; overflow-y: auto; font-size: 12px; margin-top: 20px; direction: ltr; text-align: left; border-radius: 6px; font-family: monospace; }
        .balance-box { padding: 20px; background: #e8f5e9; border: 1px solid #c8e6c9; text-align: center; display: none; border-radius: 8px; margin-bottom: 15px; }
        .balance-num { font-size: 2em; font-weight: bold; color: var(--success); display: block; }

        /* Suggestions */
        .suggestions-list { border: 1px solid #ddd; max-height: 220px; overflow-y: auto; display: none; position: absolute; background: white; width: 100%; z-index: 100; box-shadow: 0 8px 16px rgba(0,0,0,0.15); border-radius: 0 0 8px 8px; }
        .suggestion-item { padding: 14px; border-bottom: 1px solid #f1f1f1; cursor: pointer; }
        .suggestion-item:hover { background: #e3f2fd; color: var(--primary); font-weight: bold; }

        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.95rem; background: white; }
        th, td { padding: 12px; border: 1px solid #eee; text-align: center; }
        th { background: var(--primary); color: white; }
        tr:nth-child(even) { background-color: #f9f9f9; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <h3 style="text-align:center; margin:10px 0 20px 0; color:var(--primary)">ğŸ¥ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ¯Ù„Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ</h3>

    <div class="nav-tabs">
        <div id="tab-import" class="nav-item active" onclick="switchTab('import')">ğŸ“‚ Ø§Ù„Ù…Ù„ÙØ§Øª</div>
        <div id="tab-dispense" class="nav-item" onclick="switchTab('dispense')">ğŸ’Š ØµØ±Ù Ø§Ù„Ù…ÙˆØ§Ø¯</div>
        <div id="tab-report" class="nav-item" onclick="switchTab('report')">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
    </div>

    <div id="import" class="section active">
        <div style="background:#e3f2fd; padding:25px; border-radius:10px; text-align:center; border: 1px dashed var(--primary);">
            <h4 style="margin-top:0; color:var(--primary)">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h4>
            <p style="color:#555; font-size:0.9rem; margin-bottom:15px;">ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ Ù…Ù„Ù Excel Ø¬Ø¯ÙŠØ¯ Ù„Ù„ØªØ£Ø³ÙŠØ³ØŒ Ø£Ùˆ Ù…Ù„Ù JSON Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.</p>
            
            <input type="file" id="fileInput" accept=".xlsx, .xls, .csv, .json" style="display:block; margin:0 auto 15px auto;">
            <button class="btn-import" onclick="processFile()">ğŸš€ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù</button>
        </div>

        <div class="debug-console" id="logsContent">> System Ready... Waiting for file.</div>
        <button class="btn-reset" onclick="clearSystem()">âš ï¸ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ­Ø°Ù ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Format)</button>
    </div>

    <div id="dispense" class="section">
        <div style="background:#fff3e0; padding:12px; border-radius:6px; margin-bottom:20px; font-size:0.9rem; color:#e65100; text-align:center; border:1px solid #ffe0b2;">
            ğŸ’¡ <b>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¹Ù…Ù„:</b> Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¯ÙˆØ§Ø¡ Ø£ÙˆÙ„Ø§Ù‹ØŒ ÙˆØ³ÙŠØ¸Ù‡Ø± Ù„Ùƒ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¤Ø³Ø³Ø§Øª Ø§Ù„ØªÙŠ ØªÙ…Ù„Ùƒ Ø±ØµÙŠØ¯Ø§Ù‹ ÙÙ‚Ø·.
        </div>

        <div class="form-group">
            <label>1. Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© (Ø§ÙƒØªØ¨ 3 Ø£Ø­Ø±Ù Ù„Ù„Ø¨Ø­Ø«):</label>
            <input type="text" id="dispenseSearch" onkeyup="handleSearch(this.value, 'dispense')" placeholder="Ù…Ø«Ù„Ø§Ù‹: Paracetamol..." autocomplete="off">
            <span class="clear-btn" onclick="clearSearch('dispense')" id="clearDispense">âœ–</span>
            <div class="suggestions-list" id="dispenseList"></div>
            <input type="hidden" id="dispenseItemHidden">
        </div>

        <div class="form-group">
            <label>2. Ø§Ù„Ù…Ø¤Ø³Ø³Ø© Ø§Ù„Ù…Ø³ØªÙÙŠØ¯Ø©:</label>
            <select id="dispenseInst" onchange="checkDispenseBal()" disabled>
                <option value="">-- ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§Ø¯Ø© Ø£ÙˆÙ„Ø§Ù‹ --</option>
            </select>
        </div>

        <div id="balBox" class="balance-box">
            Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="balNum" class="balance-num">0</span>
        </div>

        <div class="form-group">
            <label>3. Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØµØ±ÙˆÙØ©:</label>
            <input type="number" id="qtyInput" placeholder="Ø§Ù„Ø¹Ø¯Ø¯">
        </div>
        <button class="btn-save" onclick="doDispense()">âœ… Ø­ÙØ¸ ÙˆØªØ«Ø¨ÙŠØª Ø§Ù„ØµØ±Ù</button>
    </div>

    <div id="report" class="section">
        <div style="background: #f3e5f5; padding: 20px; border-radius: 10px; border:1px solid #e1bee7;">
            <label style="color:#7b1fa2">ğŸ” Ø§Ø³ØªØ¹Ù„Ø§Ù… ØªÙØµÙŠÙ„ÙŠ:</label>
            <div class="form-group" style="margin-bottom:0;">
                <input type="text" id="reportSearch" onkeyup="handleSearch(this.value, 'report')" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø¯ÙˆØ§Ø¡ Ù„Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙˆØ²ÙŠØ¹..." autocomplete="off">
                <span class="clear-btn" onclick="clearSearch('report')" id="clearReport">âœ–</span>
                <div class="suggestions-list" id="reportList"></div>
                <input type="hidden" id="reportItemHidden">
            </div>
            <button class="btn-report" onclick="generateReport()">Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„</button>
        </div>
        
        <div style="overflow-x:auto; margin-top:10px;">
            <table id="reportTable">
                <thead><tr><th>Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</th><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬</th><th>Ø§Ù„Ù…ØµØ±ÙˆÙ</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th></tr></thead>
                <tbody id="reportBody">
                    <tr><td colspan="5" style="padding:25px; color:#aaa;">Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ø¨Ø­Ø«</td></tr>
                </tbody>
            </table>
        </div>

        <hr style="margin: 25px 0; border: 0; border-top: 1px solid #eee;">
        <button class="btn-backup" onclick="exportBackup()">ğŸ’¾ Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© (Backup)</button>
    </div>
</div>

<script>
    // --- CORE UTILS ---
    function log(msg) {
        const box = document.getElementById('logsContent');
        box.innerHTML += `<div>> ${msg}</div>`;
        box.scrollTop = box.scrollHeight;
    }

    let db = [];
    let uniqueItems = [];

    window.onload = function() {
        if (typeof XLSX === 'undefined') log("Loading SheetJS library...");
        loadDB();
    };

    function switchTab(id) {
        // Toggle Tabs
        document.querySelectorAll('.section').forEach(d => d.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(d => d.classList.remove('active'));
        
        document.getElementById(id).classList.add('active');
        const btn = document.getElementById('tab-' + id);
        if(btn) btn.classList.add('active');
    }

    // --- FILE HANDLER (Unified) ---
    function processFile() {
        const f = document.getElementById('fileInput').files[0];
        if(!f) return log("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹.");
        
        const fileName = f.name.toLowerCase();

        // A) RESTORE BACKUP (JSON)
        if(fileName.endsWith('.json')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if(Array.isArray(data)) {
                        db = data;
                        saveDB();
                        log(`Restored ${db.length} records from JSON.`);
                        alert(`âœ… ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­.\nØ¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${db.length}\nØ³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ùƒ Ù„ØµÙØ­Ø© Ø§Ù„ØµØ±Ù.`);
                        switchTab('dispense');
                    } else {
                        alert("Ù…Ù„Ù ØªØ§Ù„Ù Ø£Ùˆ ØºÙŠØ± ØµØ­ÙŠØ­!");
                    }
                } catch(err) { log("Error: " + err); }
            };
            reader.readAsText(f);
            return;
        }

        // B) IMPORT EXCEL (XLSX)
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(sheet, {header: 1});
                parseExcelRows(rows);
            } catch(err) { log("Excel Error: " + err); }
        };
        reader.readAsArrayBuffer(f);
    }

    function parseExcelRows(rows) {
        let headerIdx = -1;
        let instCols = [];

        // Find Header
        for(let i=0; i<Math.min(rows.length, 50); i++) {
            const str = JSON.stringify(rows[i]);
            if(str.includes("Ù…Ø³ØªØ´ÙÙ‰") || str.includes("Ù‚Ø·Ø§Ø¹")) {
                headerIdx = i;
                rows[i].forEach((cell, idx) => {
                    if(typeof cell === 'string' && (cell.includes("Ù…Ø³ØªØ´ÙÙ‰") || cell.includes("Ù‚Ø·Ø§Ø¹") || cell.includes("Ù…Ø±ÙƒØ²"))) {
                        instCols.push({name: cell.trim(), idx: idx});
                    }
                });
                break;
            }
        }

        if(headerIdx === -1) return log("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø·Ø± Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† (Ù…Ø³ØªØ´ÙÙ‰/Ù‚Ø·Ø§Ø¹)!");

        let count = 0;
        // Start Parsing
        for(let i=headerIdx+1; i<rows.length; i++) {
            const row = rows[i];
            if(!row || !row[0]) continue;
            
            const item = String(row[0]).trim();
            if(item.length < 2 || item.includes("SYSTEM")) continue;

            instCols.forEach(inst => {
                let val = row[inst.idx];
                let quota = typeof val === 'number' ? val : parseInt(String(val).replace(/[^0-9]/g, '')) || 0;
                
                if(quota > 0) {
                    let exists = db.find(x => x.inst === inst.name && x.item === item);
                    if(exists) exists.quota = quota;
                    else {
                        db.push({inst: inst.name, item: item, quota: quota, used: 0});
                        count++;
                    }
                }
            });
        }
        
        saveDB();
        log(`Imported ${count} records.`);
        alert(`âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${count} Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯.\nØ³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ùƒ Ù„ØµÙØ­Ø© Ø§Ù„ØµØ±Ù.`);
        switchTab('dispense');
    }

    // --- SEARCH & FILTER ---
    function handleSearch(txt, type) {
        const listId = type === 'dispense' ? 'dispenseList' : 'reportList';
        const clearBtnId = type === 'dispense' ? 'clearDispense' : 'clearReport';
        
        const list = document.getElementById(listId);
        document.getElementById(clearBtnId).style.display = txt.length > 0 ? 'block' : 'none';

        if(txt.length < 3) { list.style.display = 'none'; return; }

        const matches = uniqueItems.filter(i => i.toLowerCase().includes(txt.toLowerCase())).slice(0, 20);
        
        list.innerHTML = '';
        if(matches.length > 0) {
            list.style.display = 'block';
            matches.forEach(m => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.innerText = m;
                div.onclick = () => selectItem(m, type);
                list.appendChild(div);
            });
        } else { list.style.display = 'none'; }
    }

    function selectItem(name, type) {
        if(type === 'dispense') {
            document.getElementById('dispenseSearch').value = name;
            document.getElementById('dispenseItemHidden').value = name;
            document.getElementById('dispenseList').style.display = 'none';
            filterInstitutionsByItem(name);
        } else {
            document.getElementById('reportSearch').value = name;
            document.getElementById('reportItemHidden').value = name;
            document.getElementById('reportList').style.display = 'none';
        }
    }

    function clearSearch(type) {
        if(type === 'dispense') {
            document.getElementById('dispenseSearch').value = '';
            document.getElementById('dispenseItemHidden').value = '';
            document.getElementById('dispenseList').style.display = 'none';
            document.getElementById('clearDispense').style.display = 'none';
            document.getElementById('dispenseInst').innerHTML = '<option>-- ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§Ø¯Ø© --</option>';
            document.getElementById('dispenseInst').disabled = true;
            document.getElementById('balBox').style.display = 'none';
        } else {
            document.getElementById('reportSearch').value = '';
            document.getElementById('reportItemHidden').value = '';
            document.getElementById('reportList').style.display = 'none';
            document.getElementById('clearReport').style.display = 'none';
        }
    }

    function filterInstitutionsByItem(itemName) {
        const instSelect = document.getElementById('dispenseInst');
        instSelect.disabled = false;
        document.getElementById('balBox').style.display = 'none';

        const validRecords = db.filter(r => r.item === itemName);
        instSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¤Ø³Ø³Ø© --</option>';
        
        if(validRecords.length === 0) {
            instSelect.innerHTML = '<option value="">ğŸš« Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­ØµØ© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø¯Ø©</option>';
            instSelect.disabled = true;
            return;
        }
        
        validRecords.sort((a, b) => a.inst.localeCompare(b.inst));
        validRecords.forEach(rec => instSelect.add(new Option(rec.inst, rec.inst)));
    }

    // --- DISPENSE ---
    function checkDispenseBal() {
        const inst = document.getElementById('dispenseInst').value;
        const item = document.getElementById('dispenseItemHidden').value;
        const box = document.getElementById('balBox');
        
        if(!inst) { box.style.display = 'none'; return; }

        const rec = db.find(x => x.inst === inst && x.item === item);
        if(rec) {
            box.style.display = 'block';
            const rem = rec.quota - rec.used;
            document.getElementById('balNum').innerText = rem;
        }
    }

    function doDispense() {
        const inst = document.getElementById('dispenseInst').value;
        const item = document.getElementById('dispenseItemHidden').value;
        const qty = parseInt(document.getElementById('qtyInput').value);

        if(!inst || !item || !qty) return alert("ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        
        const rec = db.find(x => x.inst === inst && x.item === item);
        if(!rec) return alert("Ø®Ø·Ø£: Ø§Ù„Ù…Ø§Ø¯Ø© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ù„Ù„Ù…Ø¤Ø³Ø³Ø©");
        if(qty > (rec.quota - rec.used)) return alert("âŒ Ø§Ù„Ø±ØµÙŠØ¯ Ù„Ø§ ÙŠÙƒÙÙŠ!");

        rec.used += qty;
        saveDB();
        alert("âœ… ØªÙ… Ø§Ù„ØµØ±Ù Ø¨Ù†Ø¬Ø§Ø­");
        document.getElementById('qtyInput').value = '';
        checkDispenseBal();
    }

    // --- REPORT & BACKUP ---
    function generateReport() {
        const item = document.getElementById('reportItemHidden').value;
        const tbody = document.getElementById('reportBody');
        
        if(!item) return alert("Ø§Ø®ØªØ± Ù…Ø§Ø¯Ø© Ø£ÙˆÙ„Ø§Ù‹");
        tbody.innerHTML = '';
        
        let data = db.filter(r => r.item === item);
        data.sort((a, b) => a.inst.localeCompare(b.inst));

        if(data.length === 0) { tbody.innerHTML = '<tr><td colspan="5">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>'; return; }

        let tQ=0, tU=0;
        data.forEach(r => {
            tQ+=r.quota; tU+=r.used;
            const rem = r.quota - r.used;
            tbody.innerHTML += `<tr><td>${r.inst}</td><td>${r.item}</td><td>${r.quota}</td><td>${r.used}</td><td style="color:${rem<=0?'red':'green'}; font-weight:bold">${rem}</td></tr>`;
        });
        tbody.innerHTML += `<tr style="background:#333; color:#fff; font-weight:bold"><td>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ</td><td>--</td><td>${tQ}</td><td>${tU}</td><td>${tQ-tU}</td></tr>`;
    }

    function exportBackup() {
        if(db.length === 0) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª!");
        const dataStr = JSON.stringify(db);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Pharma_Backup_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    // --- STORAGE ---
    function saveDB() {
        localStorage.setItem('pharma_v14', JSON.stringify(db));
        uniqueItems = [...new Set(db.map(r => r.item))].sort();
    }
    function loadDB() {
        const stored = localStorage.getItem('pharma_v14');
        if(stored) {
            db = JSON.parse(stored);
            uniqueItems = [...new Set(db.map(r => r.item))].sort();
            log(`Loaded ${db.length} records.`);
        }
    }
    function clearSystem() {
        if(confirm("ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª! Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) { 
            localStorage.removeItem('pharma_v14'); 
            location.reload(); 
        }
    }
</script>

</body>
</html>
