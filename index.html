<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ø³Ù†ÙˆÙŠ - Ø¯Ø§Ø¦Ø±Ø© ØµØ­Ø© Ø§Ù„Ù…Ø«Ù†Ù‰</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #2980b9;
            --success: #27ae60;
            --cancer-color: #e74c3c; /* Ù„ÙˆÙ† Ù…Ù…ÙŠØ² Ù„Ù„Ø³Ø±Ø·Ø§Ù†ÙŠØ© */
            --drug-color: #8e44ad;    /* Ù„ÙˆÙ† Ù…Ù…ÙŠØ² Ù„Ù„Ø£Ø¯ÙˆÙŠØ© */
            --bg-color: #f0f2f5;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        h2 { text-align: center; color: var(--primary); margin-bottom: 30px; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±ÙØ¹ */
        .upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
        }

        .online-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn-load {
            padding: 15px 25px;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .btn-load:active { transform: scale(0.98); }
        .btn-drugs { background-color: var(--drug-color); }
        .btn-cancer { background-color: var(--cancer-color); }
        
        .separator {
            display: flex;
            align-items: center;
            text-align: center;
            color: #718096;
            margin: 20px 0;
        }
        .separator::before, .separator::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #cbd5e0;
        }
        .separator:not(:empty)::before { margin-right: .25em; }
        .separator:not(:empty)::after { margin-left: .25em; }

        .manual-upload-btn {
            background: #cbd5e0;
            color: #2d3748;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            border: none;
        }

        /* Loading Spinner */
        #loading-msg {
            display: none;
            color: var(--accent);
            font-weight: bold;
            margin-top: 10px;
        }

        /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø§Ø¯Ø© (Wizard) */
        #wizard-section { display: none; }
        
        .progress-container {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: var(--success);
            width: 0%;
            transition: width 0.3s ease;
        }

        .item-card {
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 25px;
            background: #fff;
            text-align: center;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 10px;
        }
        
        .data-item { flex: 1; }
        .data-label { font-size: 0.9em; color: #718096; margin-bottom: 5px; }
        .data-value { font-size: 1.2em; font-weight: bold; color: var(--primary); }
        .planned-value { color: var(--accent); font-size: 1.4em; }

        .item-name-box {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #edf2f7;
        }
        .item-name-text {
            font-size: 1.1em;
            font-weight: bold;
            color: #2d3748;
            direction: ltr; /* Ù„Ù„Ø£Ø¯ÙˆÙŠØ© Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© */
        }

        .input-group { margin-top: 25px; }
        input[type="text"] {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            box-sizing: border-box;
            text-align: center;
        }
        input[type="text"]:focus {
            border-color: var(--accent);
            outline: none;
        }

        .btn-container {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        button {
            padding: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            color: white;
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.9; }
        .btn-next { background: var(--accent); flex: 2; }
        .btn-skip { background: #a0aec0; flex: 1; }
        .btn-finish { background: var(--success); width: 100%; margin-top: 20px; }

        #report-section { display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #cbd5e0; padding: 12px; text-align: center; }
        th { background: var(--primary); color: white; }
        tr:nth-child(even) { background: #f7fafc; }

        @media print {
            .no-print, .upload-area, #wizard-section { display: none !important; }
            #report-section { display: block !important; }
            body, .container { background: white; padding: 0; margin: 0; box-shadow: none; max-width: 100%; }
        }
    </style>
</head>
<body>

<div class="container">
    <h2 class="no-print">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ø³Ù†ÙˆÙŠ - Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø±ØµÙŠØ¯</h2>

    <div id="upload-section" class="upload-area no-print">
        <h3>Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„Ù Ù„Ù„Ø¨Ø¯Ø¡</h3>
        
        <div class="online-buttons">
            <button class="btn-load btn-drugs" onclick="loadFromUrl('https://raw.githubusercontent.com/kingkopra00/percentage-recived/main/drugs.xlsx')">
                ğŸ’Š ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø£Ø¯ÙˆÙŠØ© (Drugs)
            </button>
            <button class="btn-load btn-cancer" onclick="loadFromUrl('https://raw.githubusercontent.com/kingkopra00/percentage-recived/main/cancer.xlsx')">
                ğŸ—ï¸ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø³Ø±Ø·Ø§Ù†ÙŠØ© (Cancer)
            </button>
        </div>

        <div id="loading-msg">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±... ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>

        <div class="separator">Ø£Ùˆ</div>

        <button class="manual-upload-btn" onclick="document.getElementById('fileInput').click()">
            Ø±ÙØ¹ Ù…Ù„Ù Excel Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø² ğŸ“‚
        </button>
        <input type="file" id="fileInput" accept=".xlsx, .xls" style="display: none;">
    </div>

    <div id="wizard-section">
        <div class="progress-container">
            <div id="progress-bar" class="progress-bar"></div>
        </div>
        <p style="text-align: center; color: #718096;">Ù…Ø§Ø¯Ø© <span id="current-index">0</span> Ù…Ù† <span id="total-items">0</span></p>

        <div class="item-card">
            <div class="data-row">
                <div class="data-item">
                    <div class="data-label">Ø§Ù„Ø±Ù…Ø² Ø§Ù„ÙˆØ·Ù†ÙŠ</div>
                    <div class="data-value" id="disp-code">--</div>
                </div>
                <div class="data-item">
                    <div class="data-label">ØªÙ‚Ø¯ÙŠØ± Ø§Ù„Ø­Ø§Ø¬Ø© (Planned)</div>
                    <div class="data-value planned-value" id="disp-planned">0</div>
                </div>
            </div>

            <div class="item-name-box">
                <div class="data-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©</div>
                <div class="item-name-text" id="disp-name">--</div>
            </div>

            <div class="input-group">
                <label style="display:block; margin-bottom:10px; font-weight:bold;">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø© ÙØ¹Ù„ÙŠØ§Ù‹ (Ø§Ù„Ø±ØµÙŠØ¯):</label>
                <input type="text" id="input-qty" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ù‡Ù†Ø§ (ÙŠÙ‚Ø¨Ù„ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©)" onkeypress="checkEnter(event)">
            </div>

            <div class="btn-container">
                <button class="btn-skip" onclick="skipItem()">ØªØ¬Ø§ÙˆØ² (Skip)</button>
                <button class="btn-next" onclick="saveItem()">Ø­ÙØ¸ ÙˆØ§Ù†ØªÙ‚Ø§Ù„ (Next)</button>
            </div>
        </div>
        
        <button class="btn-finish" onclick="finishReport()">Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ¥ØµØ¯Ø§Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
    </div>

    <div id="report-section">
        <div style="text-align: center;">
            <h3>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ø³Ù†ÙˆÙŠ</h3>
            <p>Ø§Ù„ØªØ§Ø±ÙŠØ®: <span id="r-date"></span></p>
        </div>
        <table id="report-tbl">
            <thead>
                <tr>
                    <th>Øª</th>
                    <th>Ø§Ù„Ø±Ù…Ø² Ø§Ù„ÙˆØ·Ù†ÙŠ</th>
                    <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                    <th>ØªÙ‚Ø¯ÙŠØ± Ø§Ù„Ø­Ø§Ø¬Ø©</th>
                    <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©</th>
                    <th>Ø§Ù„Ù†Ø³Ø¨Ø© %</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div class="no-print" style="text-align: center; margin-top: 30px;">
            <button onclick="window.print()" style="background: var(--primary); width: 200px;">Ø·Ø¨Ø§Ø¹Ø©</button>
            <button onclick="location.reload()" style="background: #718096; width: 200px;">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        </div>
    </div>

</div>

<script>
    let allItems = [];
    let reportData = [];
    let currentIndex = 0;

    // Ø¯Ø§Ù„Ø© ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
    function parseArabicNum(str) {
        if (!str) return 0;
        str = str.toString();
        const arabicDigits = ["Ù ", "Ù¡", "Ù¢", "Ù£", "Ù¤", "Ù¥", "Ù¦", "Ù§", "Ù¨", "Ù©"];
        for (let i = 0; i < 10; i++) {
            str = str.replace(new RegExp(arabicDigits[i], 'g'), i);
        }
        str = str.replace(/,/g, '').trim();
        return parseFloat(str);
    }

    // Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
    async function loadFromUrl(url) {
        document.getElementById('loading-msg').style.display = 'block';
        
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù");
            
            const arrayBuffer = await response.arrayBuffer();
            const data = new Uint8Array(arrayBuffer);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheet = workbook.SheetNames[0];
            const rows = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheet], {header: 1});
            
            processExcel(rows);
            
        } catch (error) {
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±: " + error.message);
        } finally {
            document.getElementById('loading-msg').style.display = 'none';
        }
    }

    // Ø¯Ø§Ù„Ø© Ø§Ù„Ø±ÙØ¹ Ø§Ù„ÙŠØ¯ÙˆÙŠ
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.SheetNames[0];
                const rows = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheet], {header: 1});
                processExcel(rows);
            } catch (err) {
                alert("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: " + err.message);
            }
        };
        reader.readAsArrayBuffer(file);
    });

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    function processExcel(rows) {
        allItems = [];
        let headerIndex = -1;

        for(let i=0; i < Math.min(rows.length, 50); i++) {
            const str = JSON.stringify(rows[i] || []).toUpperCase();
            if(str.includes("NATIONAL CODE")) {
                headerIndex = i;
                break;
            }
        }

        if(headerIndex === -1) {
            alert("Ø§Ù„Ù…Ù„Ù Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ NATIONAL CODE.");
            return;
        }

        for(let i = headerIndex + 1; i < rows.length; i++) {
            const row = rows[i];
            if(!row || row.length === 0) continue;

            let codeIndex = -1;
            let codeVal = "";
            
            for(let c=0; c < Math.min(row.length, 5); c++) {
                let cell = (row[c] || "").toString().trim();
                if(/^[0-9A-Z]{2,3}-[A-Z0-9]{3}-[A-Z0-9]{3}/.test(cell)) {
                    codeIndex = c;
                    codeVal = cell;
                    break;
                }
            }

            if(codeIndex !== -1) {
                let nameVal = (row[codeIndex + 1] || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ").toString().trim();
                let plannedVal = 0;
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒÙ…ÙŠØ© Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ†
                for(let j = row.length - 1; j > codeIndex; j--) {
                    let cell = row[j];
                    if(cell !== undefined && cell !== null && cell !== "") {
                        let num = parseArabicNum(cell);
                        if(!isNaN(num)) {
                            plannedVal = num;
                            break;
                        }
                    }
                }

                allItems.push({
                    code: codeVal,
                    name: nameVal,
                    planned: plannedVal
                });
            }
        }

        if(allItems.length > 0) {
            startApp();
        } else {
            alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ÙˆØ§Ø¯ ØµØ§Ù„Ø­Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù.");
        }
    }

    function startApp() {
        document.getElementById('upload-section').style.display = 'none';
        document.getElementById('wizard-section').style.display = 'block';
        document.getElementById('total-items').innerText = allItems.length;
        loadItem();
    }

    function loadItem() {
        if(currentIndex >= allItems.length) {
            finishReport();
            return;
        }

        const item = allItems[currentIndex];
        document.getElementById('current-index').innerText = currentIndex + 1;
        document.getElementById('disp-code').innerText = item.code;
        document.getElementById('disp-name').innerText = item.name;
        document.getElementById('disp-planned').innerText = item.planned.toLocaleString('en-US');
        
        const input = document.getElementById('input-qty');
        input.value = '';
        input.focus();

        const pct = ((currentIndex) / allItems.length) * 100;
        document.getElementById('progress-bar').style.width = pct + "%";
    }

    function saveItem() {
        const input = document.getElementById('input-qty');
        const valRaw = input.value;
        const received = parseArabicNum(valRaw);

        if(isNaN(received) && valRaw.trim() !== "") {
             alert("Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø· Ø±Ø¬Ø§Ø¡Ù‹.");
             return;
        }
        
        if(valRaw.trim() === "") {
            alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø£Ùˆ Ø§Ø¶ØºØ· ØªØ¬Ø§ÙˆØ².");
            return;
        }

        const item = allItems[currentIndex];
        let percent = 0;
        if(item.planned > 0) percent = ((received / item.planned) * 100).toFixed(1);

        reportData.push({
            ...item,
            received: received,
            percent: percent
        });

        currentIndex++;
        loadItem();
    }

    function skipItem() {
        currentIndex++;
        loadItem();
    }

    function checkEnter(e) {
        if(e.key === "Enter") saveItem();
    }

    function finishReport() {
        document.getElementById('wizard-section').style.display = 'none';
        document.getElementById('report-section').style.display = 'block';
        document.getElementById('r-date').innerText = new Date().toLocaleDateString('ar-IQ');

        const tbody = document.querySelector("#report-tbl tbody");
        tbody.innerHTML = "";

        if(reportData.length === 0) {
            tbody.innerHTML = "<tr><td colspan='6'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¯Ø®Ù„Ø©.</td></tr>";
            return;
        }

        reportData.forEach((item, idx) => {
            const tr = `
                <tr>
                    <td>${idx + 1}</td>
                    <td>${item.code}</td>
                    <td style="direction:ltr; text-align:left;">${item.name}</td>
                    <td>${item.planned.toLocaleString('en-US')}</td>
                    <td>${item.received.toLocaleString('en-US')}</td>
                    <td style="font-weight:bold; color: ${item.percent < 50 ? 'red' : 'green'}">${item.percent}%</td>
                </tr>
            `;
            tbody.innerHTML += tr;
        });
    }
</script>

</body>
</html>
