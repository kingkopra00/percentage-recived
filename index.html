<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ø³Ù†ÙˆÙŠ - Ø¯Ø§Ø¦Ø±Ø© ØµØ­Ø© Ø§Ù„Ù…Ø«Ù†Ù‰</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #2980b9;
            --success: #27ae60;
            --cancer-color: #e74c3c;
            --drug-color: #8e44ad;
            --bg-color: #f0f2f5;
            --highlight-bg: #fff3cd;
            --highlight-text: #856404;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        h2 { text-align: center; color: var(--primary); margin-bottom: 30px; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±ÙØ¹ */
        .upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
        }

        .online-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn-load {
            padding: 15px 25px;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .btn-load:active { transform: scale(0.98); }
        .btn-drugs { background-color: var(--drug-color); }
        .btn-cancer { background-color: var(--cancer-color); }
        
        .manual-upload-btn {
            background: #cbd5e0;
            color: #2d3748;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            border: none;
            margin-top: 10px;
        }

        #loading-msg {
            display: none;
            color: var(--accent);
            font-weight: bold;
            margin-top: 10px;
        }

        /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø§Ø¯Ø© (Wizard) */
        #wizard-section { display: none; }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª */
        .search-container {
            position: relative;
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: #f8fafc;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .search-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #cbd5e0;
            border-radius: 5px;
            font-size: 16px;
        }

        .search-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .suggestions-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #cbd5e0;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none;
        }

        .suggestion-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            text-align: left;
            direction: ltr;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background-color: #ebf8ff; }

        .suggestion-code {
            font-size: 0.85em;
            color: #718096;
            background: #edf2f7;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 10px;
        }

        .suggestion-name {
            font-weight: bold;
            color: #2d3748;
            flex: 1;
            font-size: 0.9em;
        }

        .progress-container {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            margin-bottom: 10px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: var(--success);
            width: 0%;
            transition: width 0.3s ease;
        }

        .item-card {
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 25px;
            background: #fff;
        }

        .header-row {
            text-align: center;
            margin-bottom: 15px;
            color: #718096;
            font-size: 0.9em;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .header-code {
            font-weight: bold;
            color: var(--primary);
            font-size: 1.1em;
        }

        .info-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: stretch;
        }

        .info-box {
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .box-name {
            flex: 2;
            background-color: #f8fafc;
            overflow: hidden; 
        }

        .box-planned {
            flex: 1;
            background-color: var(--highlight-bg);
            border-color: #ffeeba;
        }

        .data-label {
            font-size: 0.85em;
            color: #718096;
            margin-bottom: 5px;
            font-weight: normal;
        }

        .data-value {
            font-weight: bold;
            line-height: 1.3;
        }

        .planned-text { 
            color: var(--highlight-text); 
            font-size: 1.8em; 
        }
        
        .name-text { 
            color: #2d3748; 
            direction: ltr; 
            font-size: 1.3em; 
            word-break: break-word;
        }

        .input-group { margin-top: 20px; text-align: center; }
        input[type="text"].qty-input {
            width: 100%;
            padding: 15px;
            font-size: 20px;
            font-weight: bold;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            box-sizing: border-box;
            text-align: center;
            color: var(--primary);
        }
        input[type="text"].qty-input:focus {
            border-color: var(--accent);
            outline: none;
            background-color: #fff;
        }

        .btn-container {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }
        button {
            padding: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            color: white;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        button:hover { opacity: 0.9; }
        
        .btn-back { background: #718096; flex: 1; }
        .btn-skip { background: #a0aec0; flex: 1; }
        .btn-next { background: var(--accent); flex: 3; }
        .btn-finish { background: var(--success); width: 100%; margin-top: 20px; }

        #report-section { display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #cbd5e0; padding: 12px; text-align: center; }
        th { background: var(--primary); color: white; }
        tr:nth-child(even) { background: #f7fafc; }

        @media print {
            .no-print, .upload-area, #wizard-section { display: none !important; }
            #report-section { display: block !important; }
            body, .container { background: white; padding: 0; margin: 0; box-shadow: none; max-width: 100%; }
        }
    </style>
</head>
<body>

<div class="container">
    <h2 class="no-print">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ø³Ù†ÙˆÙŠ - Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø±ØµÙŠØ¯</h2>

    <div id="upload-section" class="upload-area no-print">
        <h3>Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„Ù Ù„Ù„Ø¨Ø¯Ø¡</h3>
        
        <div class="online-buttons">
            <button class="btn-load btn-drugs" onclick="loadFromUrl('https://raw.githubusercontent.com/kingkopra00/percentage-recived/main/drugs.xlsx')">
                ğŸ’Š ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø£Ø¯ÙˆÙŠØ©
            </button>
            <button class="btn-load btn-cancer" onclick="loadFromUrl('https://raw.githubusercontent.com/kingkopra00/percentage-recived/main/cancer.xlsx')">
                ğŸ—ï¸ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø³Ø±Ø·Ø§Ù†ÙŠØ©
            </button>
        </div>

        <div id="loading-msg">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù...</div>

        <p style="color:#aaa; margin:15px 0;">---------------- Ø£Ùˆ ----------------</p>

        <button class="manual-upload-btn" onclick="document.getElementById('fileInput').click()">
            Ø±ÙØ¹ Ù…Ù„Ù Excel Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø² ğŸ“‚
        </button>
        <input type="file" id="fileInput" accept=".xlsx, .xls" style="display: none;">
    </div>

    <div id="wizard-section">
        
        <div class="search-container">
            <input type="text" id="search-input" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© Ø£Ùˆ Ø§Ù„Ø±Ù…Ø²..." onkeypress="checkSearchEnter(event)">
            <button class="search-btn" onclick="searchItem()">Ø¨Ø­Ø« ğŸ”</button>
            <div id="suggestions-list" class="suggestions-list"></div>
        </div>

        <div class="progress-container">
            <div id="progress-bar" class="progress-bar"></div>
        </div>
        <p style="text-align: center; color: #718096; margin-bottom: 10px;">
            Ù…Ø§Ø¯Ø© <span id="current-index" style="font-weight:bold; color:var(--accent)">0</span> Ù…Ù† <span id="total-items">0</span>
        </p>

        <div class="item-card">
            <div class="header-row">
                Ø§Ù„Ø±Ù…Ø² Ø§Ù„ÙˆØ·Ù†ÙŠ: <span class="header-code" id="disp-code">--</span>
            </div>

            <div class="info-container">
                <div class="info-box box-name">
                    <div class="data-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©</div>
                    <div class="data-value name-text" id="disp-name">--</div>
                </div>

                <div class="info-box box-planned">
                    <div class="data-label">ØªÙ‚Ø¯ÙŠØ± Ø§Ù„Ø­Ø§Ø¬Ø©</div>
                    <div class="data-value planned-text" id="disp-planned">0</div>
                </div>
            </div>

            <div class="input-group">
                <label style="display:block; margin-bottom:10px; font-weight:bold; color:#4a5568;">
                    Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø© ÙØ¹Ù„ÙŠØ§Ù‹ (Ø§Ù„Ø±ØµÙŠØ¯):
                </label>
                <input type="text" id="input-qty" class="qty-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ù‡Ù†Ø§" onkeypress="checkEnter(event)">
            </div>

            <div class="btn-container">
                <button class="btn-back" onclick="prevItem()" id="btn-back">â¬…ï¸ Ø±Ø¬ÙˆØ¹</button>
                <button class="btn-skip" onclick="skipItem()">ØªØ¬Ø§ÙˆØ² â­ï¸</button>
                <button class="btn-next" onclick="saveItem()">Ø­ÙØ¸ ÙˆØ§Ù†ØªÙ‚Ø§Ù„ âœ…</button>
            </div>
        </div>
        
        <button class="btn-finish" onclick="finishReport()">Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ¥ØµØ¯Ø§Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
    </div>

    <div id="report-section">
        <div style="text-align: center;">
            <h3>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ø³Ù†ÙˆÙŠ</h3>
            <p>Ø§Ù„ØªØ§Ø±ÙŠØ®: <span id="r-date"></span></p>
        </div>
        <table id="report-tbl">
            <thead>
                <tr>
                    <th>Øª</th>
                    <th>Ø§Ù„Ø±Ù…Ø² Ø§Ù„ÙˆØ·Ù†ÙŠ</th>
                    <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                    <th>ØªÙ‚Ø¯ÙŠØ± Ø§Ù„Ø­Ø§Ø¬Ø©</th>
                    <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©</th>
                    <th>Ø§Ù„Ù†Ø³Ø¨Ø© %</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div class="no-print" style="text-align: center; margin-top: 30px;">
            <button onclick="window.print()" style="background: var(--primary); width: 200px;">Ø·Ø¨Ø§Ø¹Ø©</button>
            <button onclick="location.reload()" style="background: #718096; width: 200px;">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
        </div>
    </div>

</div>

<script>
    let allItems = [];
    let reportData = [];
    let currentIndex = 0;

    function filterEnglishText(text) {
        if (!text) return "";
        let englishOnly = text.replace(/[\u0600-\u06FF]/g, "").trim();
        englishOnly = englishOnly.replace(/\s+/g, " ");
        // Ø¥Ø°Ø§ Ù‚Ø§Ù… Ø§Ù„ÙÙ„ØªØ± Ø¨Ø­Ø°Ù ÙƒÙ„ Ø´ÙŠØ¡ (Ù„Ø£Ù† Ø§Ù„Ø§Ø³Ù… Ù…Ø®ØªÙ„Ø· Ø£Ùˆ ÙŠØ­ØªÙˆÙŠ Ø±Ù…ÙˆØ² ÙÙ‚Ø·)ØŒ Ø£Ø¹Ø¯ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ØµÙ„ÙŠ
        if (englishOnly.length < 2) return text;
        return englishOnly;
    }

    function parseArabicNum(str) {
        if (!str) return 0;
        str = str.toString();
        const arabicDigits = ["Ù ", "Ù¡", "Ù¢", "Ù£", "Ù¤", "Ù¥", "Ù¦", "Ù§", "Ù¨", "Ù©"];
        for (let i = 0; i < 10; i++) {
            str = str.replace(new RegExp(arabicDigits[i], 'g'), i);
        }
        str = str.replace(/,/g, '').trim();
        return parseFloat(str);
    }

    async function loadFromUrl(url) {
        document.getElementById('loading-msg').style.display = 'block';
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù");
            const arrayBuffer = await response.arrayBuffer();
            const data = new Uint8Array(arrayBuffer);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheet = workbook.SheetNames[0];
            const rows = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheet], {header: 1});
            processExcel(rows);
        } catch (error) {
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + error.message);
        } finally {
            document.getElementById('loading-msg').style.display = 'none';
        }
    }

    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.SheetNames[0];
                const rows = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheet], {header: 1});
                processExcel(rows);
            } catch (err) {
                alert("Ø®Ø·Ø£: " + err.message);
            }
        };
        reader.readAsArrayBuffer(file);
    });

    function processExcel(rows) {
        allItems = [];
        let headerIndex = -1;

        for(let i=0; i < Math.min(rows.length, 50); i++) {
            const str = JSON.stringify(rows[i] || []).toUpperCase();
            if(str.includes("NATIONAL CODE")) {
                headerIndex = i;
                break;
            }
        }

        if(headerIndex === -1) {
            alert("Ø§Ù„Ù…Ù„Ù Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ NATIONAL CODE.");
            return;
        }

        for(let i = headerIndex + 1; i < rows.length; i++) {
            const row = rows[i];
            if(!row || row.length === 0) continue;

            let codeIndex = -1;
            let codeVal = "";
            
            for(let c=0; c < Math.min(row.length, 5); c++) {
                let cell = (row[c] || "").toString().trim();
                // ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ¹Ø¨ÙŠØ± Ø§Ù„Ù†Ù…Ø·ÙŠ Ù„ÙŠØ´Ù…Ù„ Ø§Ù„Ø£Ø­Ø±Ù Ø§Ù„ØµØºÙŠØ±Ø© (Flag 'i' added)
                if(/^[0-9a-z]{2,3}-[a-z0-9]{3}-[a-z0-9]{3}/i.test(cell)) {
                    codeIndex = c;
                    codeVal = cell;
                    break;
                }
            }

            if(codeIndex !== -1) {
                // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ Ø¹Ù† Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù€ 3 Ø§Ù„Ù…Ø¬Ø§ÙˆØ±Ø©
                let rawName = "";
                // Ù†Ø¬Ø±Ø¨ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„ØªØ§Ù„ÙŠØŒ Ø«Ù… Ø§Ù„Ø°ÙŠ ÙŠÙ„ÙŠÙ‡...
                for (let k = 1; k <= 3; k++) {
                    if (row[codeIndex + k]) {
                        let potentialName = row[codeIndex + k].toString().trim();
                        // Ù†ØªØ£ÙƒØ¯ Ø£Ù†Ù‡ Ù„ÙŠØ³ ÙØ§Ø±ØºØ§Ù‹ ÙˆØ·ÙˆÙ„Ù‡ Ù…Ø¹Ù‚ÙˆÙ„ Ù„ÙŠÙƒÙˆÙ† Ø§Ø³Ù…Ø§Ù‹
                        if (potentialName.length > 2) {
                            rawName = potentialName;
                            break; // ÙˆØ¬Ø¯Ù†Ø§ Ø§Ù„Ø§Ø³Ù…ØŒ Ù†ØªÙˆÙ‚Ù Ø¹Ù† Ø§Ù„Ø¨Ø­Ø«
                        }
                    }
                }
                
                // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø§Ø³Ù… Ù„Ù„Ø¹Ø±Ø¶
                let cleanName = filterEnglishText(rawName);
                if (!cleanName || cleanName.trim() === "") cleanName = rawName; // ÙÙŠ Ø­Ø§Ù„ ÙØ´Ù„ Ø§Ù„ÙÙ„ØªØ±ØŒ Ø§Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø®Ø§Ù…

                let plannedVal = 0;
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒÙ…ÙŠØ© Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ†
                for(let j = row.length - 1; j > codeIndex; j--) {
                    let cell = row[j];
                    if(cell !== undefined && cell !== null && cell !== "") {
                        let num = parseArabicNum(cell);
                        if(!isNaN(num)) {
                            plannedVal = num;
                            break;
                        }
                    }
                }
                
                allItems.push({ 
                    code: codeVal, 
                    rawName: rawName,
                    displayName: cleanName,
                    planned: plannedVal 
                });
            }
        }

        if(allItems.length > 0) {
            startApp();
        } else {
            alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ù„Ø­Ø©. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù„Ù ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„ÙˆØ·Ù†ÙŠØ© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.");
        }
    }

    function startApp() {
        document.getElementById('upload-section').style.display = 'none';
        document.getElementById('wizard-section').style.display = 'block';
        document.getElementById('total-items').innerText = allItems.length;
        reportData = [];
        loadItem();
    }

    function loadItem(preserveInput = false) {
        if(currentIndex >= allItems.length) {
            finishReport();
            return;
        }

        const item = allItems[currentIndex];
        document.getElementById('current-index').innerText = currentIndex + 1;
        document.getElementById('disp-code').innerText = item.code;
        
        const nameEl = document.getElementById('disp-name');
        nameEl.innerText = item.displayName; 

        // Auto-shrink font logic
        nameEl.style.fontSize = "1.3em";
        if (item.displayName.length > 80) {
            nameEl.style.fontSize = "0.9em";
        } else if (item.displayName.length > 40) {
            nameEl.style.fontSize = "1.1em";
        }

        document.getElementById('disp-planned').innerText = item.planned.toLocaleString('en-US');
        
        document.getElementById('btn-back').disabled = (currentIndex === 0);
        document.getElementById('btn-back').style.opacity = (currentIndex === 0) ? "0.5" : "1";

        const input = document.getElementById('input-qty');
        
        const existingEntry = reportData.find(r => r.code === item.code);
        if (existingEntry) {
            input.value = existingEntry.received;
        } else if (!preserveInput) {
            input.value = '';
        }

        if (document.activeElement.id !== 'search-input') {
            input.focus();
        }

        const pct = ((currentIndex) / allItems.length) * 100;
        document.getElementById('progress-bar').style.width = pct + "%";
    }

    // --- Search Logic ---
    const searchInput = document.getElementById('search-input');
    const suggestionsList = document.getElementById('suggestions-list');

    searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        suggestionsList.innerHTML = '';

        if (query.length < 4) {
            suggestionsList.style.display = 'none';
            return;
        }

        const matches = allItems.filter(item => 
            (item.rawName && item.rawName.toLowerCase().includes(query)) || 
            (item.code && item.code.toLowerCase().includes(query))
        );

        if (matches.length > 0) {
            matches.slice(0, 15).forEach(item => { 
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.innerHTML = `
                    <span class="suggestion-name">${item.displayName}</span>
                    <span class="suggestion-code">${item.code}</span>
                `;
                div.onclick = function() {
                    const originalIndex = allItems.indexOf(item);
                    if (originalIndex !== -1) {
                        currentIndex = originalIndex;
                        loadItem(false);
                        suggestionsList.style.display = 'none';
                        searchInput.value = '';
                    }
                };
                suggestionsList.appendChild(div);
            });
            suggestionsList.style.display = 'block';
        } else {
            suggestionsList.style.display = 'none';
        }
    });

    document.addEventListener('click', function(e) {
        if (!e.target.closest('.search-container')) {
            suggestionsList.style.display = 'none';
        }
    });

    function searchItem() {
        const query = searchInput.value.toLowerCase().trim();
        if (!query) return;

        const foundIndex = allItems.findIndex(item => 
            (item.rawName && item.rawName.toLowerCase().includes(query)) || 
            (item.code && item.code.toLowerCase().includes(query))
        );

        if (foundIndex !== -1) {
            currentIndex = foundIndex;
            loadItem(false);
            suggestionsList.style.display = 'none';
            searchInput.value = '';
        } else {
            alert("Ø§Ù„Ù…Ø§Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©!");
        }
    }

    function checkSearchEnter(e) {
        if (e.key === "Enter") {
            if (suggestionsList.style.display === 'block' && suggestionsList.firstChild) {
                suggestionsList.firstChild.click();
            } else {
                searchItem();
            }
        }
    }
    // ----------------------

    function saveItem() {
        const input = document.getElementById('input-qty');
        const valRaw = input.value;
        const received = parseArabicNum(valRaw);

        if(isNaN(received) && valRaw.trim() !== "") {
             alert("Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·.");
             return;
        }
        
        if(valRaw.trim() === "") {
            alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø£Ùˆ Ø§Ø¶ØºØ· ØªØ¬Ø§ÙˆØ².");
            return;
        }

        const item = allItems[currentIndex];
        let percent = 0;
        if(item.planned > 0) percent = ((received / item.planned) * 100).toFixed(1);

        const existingIndex = reportData.findIndex(r => r.code === item.code);
        const record = { ...item, received: received, percent: percent };

        if (existingIndex !== -1) {
            reportData[existingIndex] = record;
        } else {
            reportData.push(record);
        }

        currentIndex++;
        loadItem();
    }

    function skipItem() {
        const itemCode = allItems[currentIndex].code;
        const existingIndex = reportData.findIndex(r => r.code === itemCode);
        if (existingIndex !== -1) {
            reportData.splice(existingIndex, 1);
        }
        currentIndex++;
        loadItem();
    }

    function prevItem() {
        if (currentIndex > 0) {
            currentIndex--;
            loadItem(true);
        }
    }

    function checkEnter(e) {
        if(e.key === "Enter") saveItem();
    }

    function finishReport() {
        document.getElementById('wizard-section').style.display = 'none';
        document.getElementById('report-section').style.display = 'block';
        document.getElementById('r-date').innerText = new Date().toLocaleDateString('ar-IQ');

        const tbody = document.querySelector("#report-tbl tbody");
        tbody.innerHTML = "";

        if(reportData.length === 0) {
            tbody.innerHTML = "<tr><td colspan='6'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.</td></tr>";
            return;
        }

        reportData.forEach((item, idx) => {
            const tr = `
                <tr>
                    <td>${idx + 1}</td>
                    <td>${item.code}</td>
                    <td style="direction:ltr; text-align:left;">${item.displayName}</td>
                    <td>${item.planned.toLocaleString('en-US')}</td>
                    <td>${item.received.toLocaleString('en-US')}</td>
                    <td style="font-weight:bold; color: ${item.percent < 50 ? 'red' : 'green'}">${item.percent}%</td>
                </tr>
            `;
            tbody.innerHTML += tr;
        });
    }
</script>

</body>
</html>
